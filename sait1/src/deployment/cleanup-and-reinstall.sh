#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –º–æ–¥—É–ª—è–º–∏ –∏ –∫–µ—à–µ–º

set -e

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "package.json" ]; then
    error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –£–¥–∞–ª—è–µ–º node_modules –∏ lock-—Ñ–∞–π–ª—ã
log "–£–¥–∞–ª–µ–Ω–∏–µ node_modules –∏ lock-—Ñ–∞–π–ª–æ–≤..."
rm -rf node_modules
rm -f package-lock.json
rm -f yarn.lock
rm -f pnpm-lock.yaml

# –û—á–∏—â–∞–µ–º –∫–µ—à npm
log "–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ npm..."
npm cache clean --force

# –û—á–∏—â–∞–µ–º –∫–µ—à Vite (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ -d "node_modules/.vite" ]; then
    log "–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ Vite..."
    rm -rf node_modules/.vite
fi

# –û—á–∏—â–∞–µ–º dist –ø–∞–ø–∫—É
if [ -d "dist" ]; then
    log "–û—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏ dist..."
    rm -rf dist
fi

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "–ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏..."
npm audit

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —É—è–∑–≤–∏–º–æ—Å—Ç–∏
if npm audit | grep -q "vulnerabilities"; then
    warning "–ù–∞–π–¥–µ–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –ø–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
    npm audit fix
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏–∏
log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤:"
echo "  Node.js: $(node --version)"
echo "  npm: $(npm --version)"
echo "  React: $(npm list react --depth=0 2>/dev/null | grep react || echo '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
echo "  Vite: $(npm list vite --depth=0 2>/dev/null | grep vite || echo '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"
echo "  TypeScript: $(npm list typescript --depth=0 2>/dev/null | grep typescript || echo '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')"

log "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
log "üöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å: npm run dev"

echo ""
echo "üìù –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:"
echo "   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª"
echo "   2. –£–±–µ–¥–∏—Ç—å—Å—è –≤ –≤–µ—Ä—Å–∏–∏ Node.js >= 18"
echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç—å: npm run dev"
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° sources.list
# Ð—Ð°Ð¿ÑƒÑÐº: sudo bash fix-sources-format.sh

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
    exit 1
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

info() {
    echo -e "${BLUE}[INFO] $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [ "$EUID" -ne 0 ]; then
    error "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root (sudo bash fix-sources-format.sh)"
fi

log "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° sources.list..."

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ubuntu
UBUNTU_CODENAME=$(lsb_release -cs 2>/dev/null || echo "noble")
UBUNTU_VERSION=$(lsb_release -rs 2>/dev/null || echo "24.04")

info "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð²ÐµÑ€ÑÐ¸Ñ Ubuntu: $UBUNTU_VERSION ($UBUNTU_CODENAME)"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ„Ð°Ð¹Ð»
if [ ! -f /etc/apt/sources.list ]; then
    warning "Ð¤Ð°Ð¹Ð» /etc/apt/sources.list Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»..."
else
    log "Ð¤Ð°Ð¹Ð» sources.list Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚..."
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº
    echo ""
    info "Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº):"
    head -n 10 /etc/apt/sources.list | sed 's/^/  /'
    echo ""
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
    if grep -q "^Types:" /etc/apt/sources.list 2>/dev/null; then
        warning "âŒ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ DEB822!"
        info "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ DEB822 (Types:, URIs:, etc) Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² .sources Ñ„Ð°Ð¹Ð»Ð°Ñ…"
        info "Ð”Ð»Ñ /etc/apt/sources.list Ð½ÑƒÐ¶ÐµÐ½ Ñ‚Ñ€Ð°Ð´Ð¸Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð¾Ð´Ð½Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ
        BACKUP_FILE="/etc/apt/sources.list.backup-$(date +%Y%m%d-%H%M%S)"
        log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ: $BACKUP_FILE"
        cp /etc/apt/sources.list "$BACKUP_FILE"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ DEB822 Ð² sources.list.d
        if [ -d /etc/apt/sources.list.d ]; then
            SOURCES_FILES=$(find /etc/apt/sources.list.d -name "*.sources" 2>/dev/null | wc -l)
            if [ "$SOURCES_FILES" -gt 0 ]; then
                info "ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $SOURCES_FILES .sources Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² /etc/apt/sources.list.d/"
                info "ÐžÐ½Ð¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ñ‹ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¼ sources.list"
            fi
        fi
    elif grep -q "^deb " /etc/apt/sources.list 2>/dev/null; then
        log "âœ… Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ sources.list Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ (Ñ‚Ñ€Ð°Ð´Ð¸Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹)"
        info "ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾"
        
        log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ..."
        apt clean
        if apt update; then
            log "âœ… Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾!"
            exit 0
        else
            warning "Ð•ÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²"
            info "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ sources.list..."
        fi
    else
        warning "Ð¤Ð°Ð¹Ð» sources.list Ð¿ÑƒÑÑ‚ Ð¸Ð»Ð¸ Ð¸Ð¼ÐµÐµÑ‚ Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚"
    fi
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð»Ð¸
    if [ ! -f "$BACKUP_FILE" ]; then
        BACKUP_FILE="/etc/apt/sources.list.backup-$(date +%Y%m%d-%H%M%S)"
        log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ: $BACKUP_FILE"
        cp /etc/apt/sources.list "$BACKUP_FILE"
    fi
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ sources.list
log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ sources.list Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ..."

tee /etc/apt/sources.list > /dev/null <<EOF
# Ubuntu $UBUNTU_VERSION ($UBUNTU_CODENAME) Main Repositories
deb http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse
deb-src http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse

# Ubuntu Updates
deb http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME}-updates main restricted universe multiverse
deb-src http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME}-updates main restricted universe multiverse

# Ubuntu Backports
deb http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME}-backports main restricted universe multiverse
deb-src http://archive.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME}-backports main restricted universe multiverse

# Ubuntu Security Updates
deb http://security.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME}-security main restricted universe multiverse
deb-src http://security.ubuntu.com/ubuntu/ ${UBUNTU_CODENAME}-security main restricted universe multiverse
EOF

log "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ sources.list Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ"

echo ""
info "ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ sources.list:"
cat /etc/apt/sources.list | grep -v '^#' | grep -v '^$' | sed 's/^/  /'
echo ""

# ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ
log "ðŸ—‘ï¸ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° apt..."
apt clean
apt autoclean

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ
log "ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ²..."
if apt update; then
    log "âœ… Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾!"
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
    echo ""
    info "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²:"
    apt-cache stats | grep "^Packages:" | sed 's/^/  /'
    
    echo ""
    log "ðŸŽ‰ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    
    if [ -f "$BACKUP_FILE" ]; then
        info "Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð°: $BACKUP_FILE"
        info "Ð”Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: sudo cp $BACKUP_FILE /etc/apt/sources.list"
    fi
    
    echo ""
    info "Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ: sudo bash deploy.sh"
else
    error "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²"
fi